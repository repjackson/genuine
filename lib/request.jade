template(name='requests')
    .ui.stackable.padded.grid
        .four.wide.column
            .ui.inline.header 
                +i name='hand-holding-heart'
                |#{counter}
                |requests
            if currentUser 
                +add_doc_button model='request'
            div
            div
            +facet model='request' key='tag'
            |sort by
            +sort_direction_toggle
            +set_sort_key key='views' label='views' icon='eye'
            // +set_sort_key key='datetime_available' label='available' icon='clock'
            +set_sort_key key='price' label='price' icon='money'
            +set_sort_key key='_timestamp' label='added' icon='clock'
            +set_sort_key key='comment_count' label='comment count' icon='chat'
            // |&nbsp;
            // |&nbsp;
            // +limit_menu
        .twelve.wide.column
            .sorting_row
                .ui.button 
                    i.chevron.up.blue.icon 
                    |to me
                .ui.button 
                    i.chevron.down.teal.icon 
                    |from me
                .ui.button
                    i.green.checkmark.icon
                    |paid
                .ui.button 
                    i.circle.outline.icon
                    |unpaid
            .spacer 
            if subs_ready     
                .ui.stackable.centered.cards.scrolling
                    each model_docs 'request'
                        +request_card
            else 
                .ui.center.aligned.basic.segment
                    i.massive.yellow.notched.circle.loading.icon


template(name='request_card')
    .ui.card(class=request_card_class)
        a.image.fly_right(href="/request/#{_id}/") 
            img.ui.zoomer.pointer.goto_request.image(src="{{c.url image_id width=400 height=300 crop='pad'}}")
        .content
            if paid 
                i.green.large.money.icon
            if complete
                i.green.large.checkmar.icon
            a.ui.inline.header.zoomer.fly_right(href="/request/#{_id}/") 
                | #{title}
            .ui.large.basic.green.label(title='amount') #{amount}pts
            
            each tags
                a.ui.small.link.label.flat_pick_tag.spaced #{this}
            .right.floated.meta
                | #{when}
            unless anonymous
                a(href="/user/#{_author_username}")
                    img.ui.avatar.image(src="{{c.url _author.image_id width=400 height=600 crop='fit'}}")
                    |#{_author_username}
            // .ui.label #{inventory} units available
            // .ui.label #{request_total} total requests
            if request
                +i name='deliver-request' cl='ui avatar image'
                if request_fee
                    .ui.inline.header(title='request fee') $#{request_fee}
            if open
                +i name='checkmark' cl='ui avatar image'
            else 
                i.ban.icon(title='not open to new requests')
            // if can_edit
            //     a.ui.large.icon.button(href="/request/#{_id}/edit")
            //         i.pencil.icon
            if location_tags
                i.marker.icon
                each location_tags  
                    .ui.label #{this}
            if group_id 
                +group_info
        //- .ui.bottom.attached.buttons        
        //-     .ui.green.button.quickbuy
        //-         i.lightning.icon
        //-         |buy
        //-     a.ui.button(href="/request/#{_id}/")
        //-         |view
        //-         i.right.chevron.icon



template(name='request_view')
    with current_doc
        .ui.stackable.padded.grid
            .row
                .four.wide.column 
                    // with request_rental
                    .ui.inline.header 
                        |#{title}
                    a.ui.compact.large.button.fly_left(href="/requests/")
                        // img.ui.rounded.image(src="{{c.url image_id width=400 height=400}}")
                        i.left.chevron.icon
                        +i name='horn'
                        strong requests
                    +image_view key='image' label='image' direct=true
                    .ui.small.grey.header 
                        |viewing request #{_id} 
                    if complete 
                        .ui.large.green.label complete 
                    else 
                        .ui.large.label ongoing (incomplete)
                    +request_events
                    +group_widget
                .eight.wide.column
                    if paid 
                        .ui.big.green.label
                            i.large.money.icon
                            |paid
                    if complete
                        .ui.big.green.label
                            i.large.checkmar.icon
                            |complete

                    // a.ui.circular.compact.button(href="/food/#{food_id}/")
                    //     i.left.chevron.icon
                    //     img.ui.avatar.image(src="{{c.url request_rental.image width=200 height=200}}")    
                    //     |#{request_rental.title}
                    if can_edit
                        a.ui.large.circular.icon.button(href="/request/#{_id}/edit")
                            i.pencil.large.icon
                    .ui.header
                        i.clock.icon
                        |#{when}
                    div
                    +viewing_info
                    +textarea_view key='description'
                    if can_edit
                        .ui.basic.red.button.cancel_request
                            i.remove.icon
                            |cancel
                    +comments
                .four.wide.column
                    .ui.header 
                        +i name='donate'
                        | requester
                        strong #{_author_username}
                    with _author
                        +user_card
                    .ui.header 
                        small seller
                        strong #{_seller_username}
                    .ui.header status: #{status}


template(name='request_events')
    .ui.header
        i.rss.icon
        |request events
    .ui.bulleted.list
        each log_events
            .item #{text} #{when}

    
    
    
    
template(name='request_edit')
    with current_doc
        .ui.stackable.padded.grid
            .two.column.row
                .column 
                    // a.ui.big.fluid.button(href="/request/#{_id}/" title='save')
                    //     i.save.icon
                    //     //- +i name='submit-progress--v1'        
                    //     .ui.inline.header save draft     
                    .ui.header 
                        strong #{rental.title}
                        small request
                    +text_edit key='title' label='title'
                    +boolean_edit key='urgent' label='urgent'
                    
                    +number_edit key='amount' label='request amount (points)' min='0' max='1000'
                    // with rental
                    //     .ui.inline.header #{daily_rate}c
                    //         small /day
                    //     |&nbsp;
                    //     |&nbsp;
                    //     +image_view key='image' label='image' direct=true cl='ui rounded image'
                    // if can_buy
                    //     .ui.header 
                    //         small your balance
                    //         |{{fixed currentUser.credit}} 
                    //     .ui.header
                    //         small
                    //         //- | -  #{cost} 
                    //         | -  #{total_cost} 
                    //     .ui.header
                    //         small balance after purchase
                    //         small = 
                    //         //- small balance after purchase 
                    //         |#{member_balance_after_request}
                    // if need_credit
                    //     .ui.header need credit
                    //     .ui.header 
                    //         |{{fixed currentUser.credit}} 
                    //     .ui.header
                    //         small cost
                    //         | #{total_cost} 
                    //     .ui.header
                    //         small balance after purchase
                    //         small = 
                    //         |#{point_balance_after_request}
                    // unless submitted
                    //     if can_buy
                    //         .ui.big.green.fluid.button.submit_request(class=submit_button_class)
                    //             |pay
                    //     else if need_credit
                    //         .ui.segemnt
                    //             .ui.header #{member_balance_after_request} credit needed to purchase
                    //             .ui.inline.header 
                    //                 i.shield.red.icon
                    //                 |add 
                    //             with currentUser
                    //                 +number_edit key='points' label='points' icon='hashtag'
                    //         // .ui.inline.input
                    //         //     input.adding_credit(type='number' value=member_balance_after_request) 
                    //         // .ui.big.teal.fluid.button.add_credit(class=submit_button_class)
                    //         //     i.plus.icon
                    //         //     |add credit to reserve
                    // else
                    if submitted
                        .ui.header submitted {{ from_now submitted_timestamp }}
                    .ui.orange.fluid.button.cancel_request
                        i.undo.icon
                        |cancel
                    img.ui.image(src="{{c.url request_rental.image_id width=200 height=200}}")    
                    // with request_rental
                    //     a.ui.small.header(href="/rental/#{rental_id}") #{title}
                    //     +image_view key='image' direct=true
                    //     +html_view key='description' direct=true
                    .ui.header 
                        small your credit: 
                        strong #{currentUser.points}pts
                    // .ui.big.label
                    //     i.sun.icon
                    //     |daily rate: #{rental_daily_rate}p/day
                    .ui.header 
                        small credit after request 
                        strong #{point_balance_after_request}p
                .column
                    +date_edit key='request_date' label='request date' icon='calendar'
                    +textarea_edit key='notes' label='notes' direct=true
                    +boolean_edit key='paid' label='paid' direct=true
                    +boolean_edit key='complete' label='complete' direct=true
                    .ui.hidden.divider
                    if can_complete
                        a.ui.large.fluid.green.button.complete_request
                            i.checkmark.large.icon   
                            |complete request
                    else 
                        .ui.header not enough points
                        a.ui.large.fluid.green.disabled.button
                            i.checkmark.large.icon   
                            |complete request
                    .ui.hidden.divider
                    if in_dev 
                        +print_this
                    if can_delete
                        .ui.red.compact.button.delete_request
                            i.remove.icon   
                            |cancel
                    else  
                        .ui.red.disabled.button(title='existing requests')
                            i.remove.icon   
                            | can't cancel  




template(name='user_requests')
    .ui.header 
        +i name='request-history'
        |user requests
    .scrolling
        each requests 
            +profile_request_item

template(name='profile_request_item')
    .ui.segment.grid
        .row
            .four.wide.column
                with request_rental
                    //- img.ui.mini.image(src=image)
                    +image_view key='image' direct=true cl='zoom ui tiny image'
            .twelve.wide.column
                .ui.header #{request_rental.title}
                a.ui.small.header.inline.lowercase(href="/request/#{_id}/")
                    |#{request_amount}c
                .ui.small.inline.header #{when} by #{_author_username}
                a.ui.button(href="/request/#{_id}/")
                    |view
                    i.right.chevron.icon
                if is_admin
                    +remove_button




